define(["jquery", "core/ajax", "core/notification"], function (e, t, n) {
  return {
    init: function () {
      function o(o, i, s) {
        t.call([
          {
            methodname: "local_recognition_handle_reaction",
            args: { action: "get_comments", recordid: o, type: "comment" },
            done: function (e) {
              e.success
                ? (i.find(".comments-list").html(e.data.html),
                  s.find(".comments-count").text(e.data.count))
                : (console.error("Comments error:", e.message),
                  n.addNotification({
                    message: e.message || "Error loading comments",
                    type: "error",
                  }));
            },
            fail: function (e) {
              console.error("AJAX error:", e),
                n.addNotification({
                  message: "Error connecting to server",
                  type: "error",
                });
            },
          },
        ]);
      }
      e(".file-input").on("change", function (t) {
        var o = t.target.files[0];
        if (o) {
          var i = e(this).data("max-size");
          if (o.size > i)
            return (
              n.addNotification({
                message: "File size must be less than 5MB",
                type: "error",
              }),
              void e(this).val("")
            );
          var s = new FileReader();
          (s.onload = function (t) {
            e(".post-attachments")
              .html(
                '\n            <div class="attachment-preview">\n              <img src="' +
                  t.target.result +
                  '" alt="Preview">\n              <div class="attachment-remove">&times;</div>\n            </div>\n          '
              )
              .show();
          }),
            s.readAsDataURL(o);
        }
      }),
        e(document).on("click", ".attachment-remove", function () {
          e(".file-input").val(""), e(".post-attachments").empty().hide();
        }),
        e(".recognition-like-btn").on("click", function (o) {
          o.preventDefault();
          var i = e(this),
            s = i.data("record-id");
          t.call([
            {
              methodname: "local_recognition_handle_reaction",
              args: { action: "like", recordid: s, type: "like" },
              done: function (e) {
                if (e.success) {
                  var t = e.data.likes,
                    o = e.data.isLiked;
                  i.find(".likes-count").text(t), i.toggleClass("liked", o);
                } else
                  console.error("Like error:", e.message),
                    n.addNotification({
                      message: e.message || "Error liking post",
                      type: "error",
                    });
              },
              fail: function (e) {
                console.error("AJAX error:", e),
                  n.addNotification({
                    message: "Error connecting to server",
                    type: "error",
                  });
              },
            },
          ]);
        }),
        e(".recognition-comments-btn").on("click", function (t) {
          t.preventDefault();
          var n = e(this),
            i = n.data("record-id"),
            s = n.closest(".recognition-post").find(".recognition-comments");
          s.slideToggle(), s.is(":visible") && o(i, s, n);
        }),
        e(".recognition-comment-form").on("submit", function (i) {
          i.preventDefault();
          var s = e(this),
            r = s.data("record-id"),
            a = s.find('input[name="content"]'),
            c = a.val().trim(),
            d = s
              .closest(".recognition-post")
              .find(".recognition-comments-btn"),
            l = s.closest(".recognition-comments");
          c &&
            t.call([
              {
                methodname: "local_recognition_handle_reaction",
                args: {
                  action: "add_comment",
                  recordid: r,
                  type: "comment",
                  content: c,
                },
                done: function (e) {
                  e.success
                    ? (a.val(""), o(r, l, d))
                    : (console.error("Comment error:", e.message),
                      n.addNotification({
                        message: e.message || "Error adding comment",
                        type: "error",
                      }));
                },
                fail: function (e) {
                  console.error("AJAX error:", e),
                    n.addNotification({
                      message: "Error connecting to server",
                      type: "error",
                    });
                },
              },
            ]);
        });
    },
  };
});
